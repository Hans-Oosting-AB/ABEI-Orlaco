<?xml version="1.0" encoding="utf-8"?><jobs><instanceguid>d9025c07-3898-433f-88ee-c5899cf947e7</instanceguid><job><id>530</id><jobname>Create BCA and prospect</jobname><disable>False</disable><emailbody /><emailmode>1</emailmode><emailsubject /><emailto>lennart.meeuse@stoneridge.com</emailto><remarks></remarks><schedulename /><schedulesettings>startat=09:43:06;beginat=00:00:00;endat=23:59:59;day1=0;day2=0;day3=0;day4=0;day5=0;day6=0;day7=0;enabled=0</schedulesettings><settings></settings><settingsxml><settings><schedule><allowmultipleprocessorinstances>false</allowmultipleprocessorinstances></schedule><general><maxjobstepactions>200</maxjobstepactions></general><jobparams /></settings></settingsxml><steps><step><id>3556</id><entity>Request</entity><action>create</action><source>129</source><target>1</target><datasource>SELECT TOP (1) *
FROM dbo._AB_vw_ABEI_BCA_Request_Create c WITH (NOLOCK)
ORDER BY referencekey</datasource><contentbody></contentbody><mapping></mapping><disable>0</disable><remarks></remarks><replace></replace><seqno>100</seqno><settings>uniquekey=;retryunique=0;</settings><settingsxml><settings><general><gen_datasource_method>0</gen_datasource_method><target_override /><referencekey>referencekey</referencekey><datacolumns><datacolumn><name>referencekey</name><type>Int32</type></datacolumn><datacolumn><name>runid</name><type>String</type></datacolumn><datacolumn><name>Type</name><type>Int32</type></datacolumn><datacolumn><name>Description</name><type>String</type></datacolumn><datacolumn><name>FreeIntField_01</name><type>Int32</type></datacolumn><datacolumn><name>Startdate</name><type>DateTime</type></datacolumn><datacolumn><name>FreeTextField_01</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_02</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_05</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_06</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_07</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_08</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_09</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_10</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_11</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_12</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_13</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_14</name><type>String</type></datacolumn><datacolumn><name>ordernumber</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_15</name><type>String</type></datacolumn><datacolumn><name>RequestComments</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_04</name><type>String</type></datacolumn><datacolumn><name>FreeTextField_03</name><type>String</type></datacolumn><datacolumn><name>YourRef</name><type>String</type></datacolumn><datacolumn><name>OurRef</name><type>String</type></datacolumn><datacolumn><name>WorkflowComments</name><type>String</type></datacolumn><datacolumn><name>EmpID</name><type>Int32</type></datacolumn></datacolumns></general></settings></settingsxml><stepname>Create BCA Request</stepname></step><step><id>3557</id><entity>-none-</entity><action>textline</action><source>0</source><target>0</target><datasource></datasource><contentbody></contentbody><mapping></mapping><disable>1</disable><remarks></remarks><replace></replace><seqno>100</seqno><settings></settings><settingsxml /><stepname>==== BCA Requests</stepname></step><step><id>3558</id><entity>-none-</entity><action>exec SQL</action><source>129</source><target>129</target><datasource>UPDATE b WITH (ROWLOCK, NOWAIT) SET 
    HID = a.HID
    , DateChanged = CURRENT_TIMESTAMP
FROM [ExactData].[dbo].[_ST_IC_BCAs] b 
    INNER JOIN [ABEI].dbo._AB_Entity_results r WITH (NOLOCK)
        ON r.runid = '%runid%'
        AND r.Entity = 'Request'
        AND r.ReferenceValue = CAST(b.ID as varchar(100))
        AND r.jobid = %jobid%
    INNER JOIN dbo._AB_sy_absences a WITH (NOLOCK) ON a.ID = r.NewKeyvalue
WHERE 1=1
    AND b.HID IS NULL -- No HID yet</datasource><contentbody /><mapping /><disable>0</disable><remarks /><replace /><seqno>110</seqno><settings /><settingsxml /><stepname>Save HID to Table</stepname></step><step><id>3559</id><entity>-none-</entity><action>exec SQL</action><source>129</source><target>129</target><datasource>INSERT INTO dbo._AB_tb_ABEI_BCA_Prospects (ReqId, HID, BCAID, runid, rowstatus, seqno)
SELECT top (1) a.id, a.HID
    , a.FreeIntField_01
    , '%runid%' as runid
    , 1 as rowstatus
    , 10 as seqno
FROM dbo._AB_sy_absences a WITH (NOLOCK) 
WHERE 1=1
    AND a.[Type] = 6043
    AND a.CustomerID IS NULL
    AND a.HID NOT IN (SELECT HID FROM dbo._AB_tb_ABEI_BCA_Prospects )
    AND a.Status = 1 -- Approved
</datasource><contentbody /><mapping /><disable>0</disable><remarks /><replace /><seqno>200</seqno><settings /><settingsxml /><stepname>Check for approved requests where the customer code is empty</stepname></step><step><id>3588</id><entity>-none-</entity><action>textline</action><source>0</source><target>0</target><datasource></datasource><contentbody></contentbody><mapping></mapping><disable>1</disable><remarks></remarks><replace></replace><seqno>200</seqno><settings></settings><settingsxml /><stepname>==== Create prospect and contacts</stepname></step><step><id>3560</id><entity>Account</entity><action>create</action><source>129</source><target>1</target><datasource>SELECT *
FROM dbo._AB_vw_ABEI_BCA_Prospect_Create c WITH (NOLOCK)
WHERE 1=1
    AND c.runid = '%runid%'</datasource><contentbody></contentbody><mapping></mapping><disable>0</disable><remarks></remarks><replace></replace><seqno>210</seqno><settings>uniquekey=;retryunique=0;</settings><settingsxml><settings><general><gen_datasource_method>0</gen_datasource_method><target_override /><referencekey>referencekey</referencekey><datacolumns><datacolumn><name>referencekey</name><type>Int32</type></datacolumn><datacolumn><name>runid</name><type>Guid</type></datacolumn><datacolumn><name>cmp_type</name><type>String</type></datacolumn><datacolumn><name>cmp_name</name><type>String</type></datacolumn><datacolumn><name>cmp_fctry</name><type>String</type></datacolumn><datacolumn><name>cmp_tel</name><type>String</type></datacolumn><datacolumn><name>cmp_fadd1</name><type>String</type></datacolumn><datacolumn><name>cmp_fcity</name><type>String</type></datacolumn><datacolumn><name>cmp_fcounty</name><type>String</type></datacolumn><datacolumn><name>cmp_fpc</name><type>String</type></datacolumn><datacolumn><name>cmp_web</name><type>String</type></datacolumn><datacolumn><name>VatNumber</name><type>String</type></datacolumn><datacolumn><name>DunsNumber</name><type>String</type></datacolumn><datacolumn><name>cnt_l_name</name><type>String</type></datacolumn><datacolumn><name>cnt_f_tel</name><type>String</type></datacolumn><datacolumn><name>cnt_email</name><type>String</type></datacolumn><datacolumn><name>DelAddress</name><type>String</type></datacolumn><datacolumn><name>DelCity</name><type>String</type></datacolumn><datacolumn><name>DeliveryTerms</name><type>String</type></datacolumn><datacolumn><name>InvAddress</name><type>String</type></datacolumn><datacolumn><name>InvCity</name><type>String</type></datacolumn><datacolumn><name>InvCounty</name><type>String</type></datacolumn><datacolumn><name>InvPostCode</name><type>String</type></datacolumn></datacolumns></general></settings></settingsxml><stepname>Create a new prospect based on the BCA data</stepname></step><step><id>3594</id><entity>-none-</entity><action>exec SQL</action><source>129</source><target>129</target><datasource>UPDATE b WITH (ROWLOCK, NOWAIT) SET 
    cmp_wwn =  r.NewKeyvalue
    , sysmodified = CURRENT_TIMESTAMP
    , rowstatus = 2 
    , seqno = %seqno%
    FROM _AB_tb_ABEI_BCA_Prospects b
    INNER JOIN [ABEI].dbo._AB_Entity_results r WITH (NOLOCK)
        ON r.runid = '%runid%'
        AND r.Entity = 'Account'
        AND r.ReferenceValue = CAST(b.ID as varchar(100))
        AND r.jobid = %jobid%
 WHERE b.runid = '%runid%'
    
-- select *    FROM _AB_tb_ABEI_BCA_Prospects b</datasource><contentbody /><mapping /><disable>0</disable><remarks /><replace /><seqno>220</seqno><settings /><settingsxml /><stepname>Save cmp_wwn to Table</stepname></step><step><id>3586</id><entity>ContactPerson</entity><action>create</action><source>1</source><target>1</target><datasource></datasource><contentbody /><mapping /><disable>1</disable><remarks /><replace /><seqno>230</seqno><settings /><settingsxml><settings><general><gen_datasource_method>0</gen_datasource_method><target_override /><referencekey /><datacolumns /></general></settings></settingsxml><stepname>TODO Create Contacts</stepname></step><step><id>3585</id><entity>Request</entity><action>update</action><source>129</source><target>1</target><datasource>SELECT ReqId as Id, HID, cmp_wwn as CustomerId, 4 as Status FROM dbo._AB_tb_ABEI_BCA_Prospects
WHERE runid = '%runid%'</datasource><contentbody></contentbody><mapping></mapping><disable>0</disable><remarks></remarks><replace></replace><seqno>260</seqno><settings>uniquekey=;retryunique=0;</settings><settingsxml><settings><general><gen_datasource_method>0</gen_datasource_method><target_override /><referencekey /><datacolumns><datacolumn><name>Id</name><type>Guid</type></datacolumn><datacolumn><name>HID</name><type>Int32</type></datacolumn><datacolumn><name>CustomerId</name><type>Guid</type></datacolumn><datacolumn><name>Status</name><type>Int32</type></datacolumn></datacolumns></general></settings></settingsxml><stepname>Update Request with prospect Id</stepname></step><step><id>3589</id><entity>-none-</entity><action>textline</action><source>0</source><target>0</target><datasource></datasource><contentbody></contentbody><mapping></mapping><disable>1</disable><remarks></remarks><replace></replace><seqno>290</seqno><settings></settings><settingsxml /><stepname>==== Delete test data</stepname></step><step><id>3590</id><entity>Request</entity><action>delete</action><source>1</source><target>1</target><datasource>Select id, hid, description from absences where type = 6043</datasource><contentbody /><mapping /><disable>1</disable><remarks /><replace /><seqno>900</seqno><settings /><settingsxml><settings><general><gen_datasource_method>0</gen_datasource_method><target_override /><referencekey /><datacolumns /></general></settings></settingsxml><stepname>Remove test requests</stepname></step><step><id>3591</id><entity>-none-</entity><action>exec SQL</action><source>129</source><target>129</target><datasource>
DELETE FROM dbo._AB_tb_ABEI_BCA_Prospects</datasource><contentbody /><mapping /><disable>1</disable><remarks /><replace /><seqno>910</seqno><settings /><settingsxml /><stepname>Remove test rows</stepname></step><step><id>3593</id><entity>Account</entity><action>delete</action><source>1</source><target>1</target><datasource>select  cmp_wwn, cmp_code, cmp_name from cicmpy with (NOLOCK) where cmp_wwn = 'e8b62419-8ff7-47ca-a655-793772726746'</datasource><contentbody /><mapping /><disable>1</disable><remarks /><replace /><seqno>920</seqno><settings /><settingsxml><settings><general><gen_datasource_method>0</gen_datasource_method><target_override /><referencekey /><datacolumns /></general></settings></settingsxml><stepname>Remove test account</stepname></step></steps></job></jobs>